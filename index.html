<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BMW Teileliste</title>

<style>
body { font-family: Arial, sans-serif; background:#f2f2f2; margin:0; }
header { background:#111; color:#fff; padding:20px; text-align:center; }
.container { padding:15px; }

input, select, button, textarea {
  width:100%; padding:10px; margin:6px 0;
  border-radius:8px; border:1px solid #ccc;
  font-size:16px;
}

button { background:#3b82f6; color:white; border:none; font-weight:bold; }
button:hover { background:#2563eb; }

.vehicle-box { background:#000; color:white; padding:12px; border-radius:12px; margin-bottom:10px; }

.part-card { background:#3b82f6; color:white; padding:15px; border-radius:12px; margin:10px 0; }
.part-header { display:flex; justify-content:space-between; align-items:center; }
.part-title { font-size:18px; font-weight:bold; }
.part-category { font-size:14px; opacity:0.9; }

.delete-btn { background:#e11d48; border:none; color:white; border-radius:8px; padding:6px 10px; font-size:16px; }

.info-box { background:#fff; color:#000; padding:10px; border-radius:8px; margin-top:10px; font-size:14px; }

.sync-btn { background:#10b981; }
.small-btn { background:#6b7280; font-size:14px; padding:8px; }

</style>
</head>

<body>

<header>
  <h2>BMW Teileliste</h2>
</header>

<div class="container">

  <!-- TOKEN -->
  <div class="vehicle-box">
    <input id="tokenInput" placeholder="GitHub Token eingeben">
    <button onclick="saveToken()">Token speichern</button>
  </div>

  <button class="sync-btn" onclick="syncToGitHub()">In GitHub speichern</button>

  <!-- FAHRZEUG -->
  <div class="vehicle-box">
    <select id="vehicleSelect" onchange="selectVehicle()"></select>
    <input id="vinInput" placeholder="FIN">
    <input id="vinNameInput" placeholder="Anzeigename (z. B. E61 Daily)">
    <button onclick="addVehicle()">Fahrzeug hinzufügen</button>
    <button class="small-btn" onclick="renameVehicle()">Fahrzeug umbenennen</button>
    <button class="small-btn" onclick="deleteVehicle()">Fahrzeug löschen</button>
  </div>

  <!-- EXTRA -->
  <button class="small-btn" onclick="addStandardParts()">Standardteile hinzufügen</button>
  <button class="small-btn" onclick="importOEM()">OEM-Daten laden</button>

  <!-- FILTER -->
  <input id="searchInput" placeholder="Teil suchen..." oninput="renderParts()">
  <select id="categoryFilter" onchange="renderParts()">
    <option value="">Alle Kategorien</option>
  </select>

  <!-- TEIL -->
  <h3>Teil hinzufügen</h3>
  <input id="partName" placeholder="Teilname">
  <input id="partCategory" placeholder="Kategorie">
  <input id="partOEM" placeholder="OEM Nummer">
  <textarea id="partDesc" placeholder="Beschreibung"></textarea>
  <button onclick="addPart()">Hinzufügen</button>

  <div id="partsList"></div>

</div>

<script>
const REPO_OWNER = "teamhuskyboy-source";
const REPO_NAME = "bmw-e61-teileplan";
const FILE_PATH = "data.json";

let GITHUB_TOKEN = localStorage.getItem("github_token") || "";
let data = { vehicles: {} };
let currentVIN = localStorage.getItem("currentVIN") || null;

async function loadFromGitHub() {
  const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`);
  const json = await res.json();
  const content = atob(json.content);
  data = JSON.parse(content);
  populateVehicles();
}

async function syncToGitHub() {
  if (!GITHUB_TOKEN) return alert("Bitte GitHub Token eingeben");

  const res = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`);
  const json = await res.json();

  const newContent = btoa(JSON.stringify(data, null, 2));

  await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${FILE_PATH}`, {
    method: "PUT",
    headers: {
      "Authorization": "Bearer " + GITHUB_TOKEN,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message: "Update BMW Daten",
      content: newContent,
      sha: json.sha
    })
  });

  alert("In GitHub gespeichert!");
}

function saveToken() {
  const t = tokenInput.value.trim();
  if (!t) return alert("Token fehlt");
  localStorage.setItem("github_token", t);
  GITHUB_TOKEN = t;
  alert("Token gespeichert");
}

function populateVehicles() {
  vehicleSelect.innerHTML = "";

  Object.keys(data.vehicles).forEach(vin => {
    const opt = document.createElement("option");
    opt.value = vin;
    opt.textContent = data.vehicles[vin].name + " (" + vin + ")";
    vehicleSelect.appendChild(opt);
  });

  if (!currentVIN && vehicleSelect.options.length) {
    currentVIN = vehicleSelect.options[0].value;
  }

  if (currentVIN) {
    vehicleSelect.value = currentVIN;
  }

  localStorage.setItem("currentVIN", currentVIN);
  renderParts();
}

function selectVehicle() {
  currentVIN = vehicleSelect.value;
  localStorage.setItem("currentVIN", currentVIN);
  renderParts();
}

function addVehicle() {
  const vin = vinInput.value.trim();
  const name = vinNameInput.value.trim();

  if (!vin || !name) return alert("FIN + Name nötig");

  if (!data.vehicles[vin]) {
    data.vehicles[vin] = { name, parts: [] };
  }

  currentVIN = vin;
  vinInput.value = "";
  vinNameInput.value = "";
  populateVehicles();
}

function renameVehicle() {
  if (!currentVIN) return alert("Kein Fahrzeug gewählt");

  const newName = prompt("Neuer Anzeigename:", data.vehicles[currentVIN].name);
  if (!newName) return;

  data.vehicles[currentVIN].name = newName;
  populateVehicles();
}

function deleteVehicle() {
  if (!currentVIN) return alert("Kein Fahrzeug gewählt");

  if (!confirm("Fahrzeug wirklich löschen?")) return;

  delete data.vehicles[currentVIN];
  currentVIN = null;
  populateVehicles();
}

function addStandardParts() {
  if (!currentVIN) return alert("Kein Fahrzeug gewählt");

  const std = [
    ["Motor", "Motor", "", ""],
    ["Getriebe", "Getriebe", "", ""],
    ["Steuergerät DDE", "Steuergeräte", "", ""],
    ["Turbolader", "Motor", "", ""],
    ["Injektoren", "Motor", "", ""],
    ["Bremsen vorne", "Bremsen", "", ""],
    ["Bremsen hinten", "Bremsen", "", ""],
    ["Fahrwerk", "Fahrwerk", "", ""],
    ["Abgasanlage", "Abgasanlage", "", ""],
    ["Kühler", "Kühlsystem", "", ""],
    ["Kotflügel", "Karosserie", "", ""],
    ["Motorhaube", "Karosserie", "", ""],
    ["Stoßstange vorne", "Karosserie", "", ""],
    ["Scheinwerfer", "Elektrik", "", ""],
    ["Kofferraumklappe", "Karosserie", "", ""]
  ];

  std.forEach(p => {
    if (!data.vehicles[currentVIN].parts.some(x => x.name === p[0])) {
      data.vehicles[currentVIN].parts.push({
        name: p[0],
        category: p[1],
        oem: p[2],
        desc: p[3]
      });
    }
  });

  renderParts();
}

function importOEM() {
  if (!currentVIN) return alert("Kein Fahrzeug gewählt");

  data.vehicles[currentVIN].parts.forEach(p => {
    if (!p.oem) {
      p.oem = "BMW-" + Math.floor(Math.random() * 1000000);
    }
  });

  renderParts();
}

function addPart() {
  if (!currentVIN) return alert("Kein Fahrzeug gewählt");

  const name = partName.value.trim();
  const category = partCategory.value.trim();
  const oem = partOEM.value.trim();
  const desc = partDesc.value.trim();

  if (!name || !category) return alert("Name + Kategorie nötig");

  if (data.vehicles[currentVIN].parts.some(p => p.name.toLowerCase() === name.toLowerCase()))
    return alert("Teil existiert bereits");

  data.vehicles[currentVIN].parts.push({ name, category, oem, desc });

  partName.value = partCategory.value = partOEM.value = partDesc.value = "";
  renderParts();
}

function deletePart(i) {
  if (!confirm("Teil löschen?")) return;
  data.vehicles[currentVIN].parts.splice(i, 1);
  renderParts();
}

function renderParts() {
  const selectedCategory = categoryFilter.value;

  partsList.innerHTML = "";
  categoryFilter.innerHTML = `<option value="">Alle Kategorien</option>`;

  if (!currentVIN || !data.vehicles[currentVIN]) return;

  const parts = data.vehicles[currentVIN].parts;
  const search = searchInput.value.toLowerCase();

  const cats = [...new Set(parts.map(p => p.category))];
  cats.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c;
    opt.textContent = c;
    categoryFilter.appendChild(opt);
  });

  categoryFilter.value = selectedCategory;
  const filterCat = selectedCategory;

  parts.forEach((p, i) => {
    if (
      (search && !p.name.toLowerCase().includes(search)) ||
      (filterCat && p.category !== filterCat)
    ) return;

    const card = document.createElement("div");
    card.className = "part-card";

    const header = document.createElement("div");
    header.className = "part-header";

    const left = document.createElement("div");

    const title = document.createElement("div");
    title.className = "part-title";
    title.textContent = p.name;

    const cat = document.createElement("div");
    cat.className = "part-category";
    cat.textContent = p.category;

    left.appendChild(title);
    left.appendChild(cat);

    const del = document.createElement("button");
    del.className = "delete-btn";
    del.textContent = "X";
    del.onclick = e => {
      e.stopPropagation();
      deletePart(i);
    };

    header.appendChild(left);
    header.appendChild(del);

    const info = document.createElement("div");
    info.className = "info-box";
    info.innerHTML = `
      <b>OEM:</b> ${p.oem || "-"}<br>
      <b>Beschreibung:</b> ${p.desc || "-"}
    `;
    info.style.display = "none";

    card.onclick = () => {
      info.style.display = info.style.display === "none" ? "block" : "none";
    };

    card.appendChild(header);
    card.appendChild(info);
    partsList.appendChild(card);
  });
}

loadFromGitHub();
</script>

</body>
</html>
